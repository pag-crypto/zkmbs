# Installation and Running

# xJsnark instructions

## Installation Instructions (MPS)

MPS is recommended for reading the code. It's possible to generate the circuit without MPS using just the source Java files (see "Generating Circuits" below).

New MPS installation: Install MPS from the "Installation" section of the xJsnark repository. Complete the rest of the instructions and Rebuild the language. Now, once xjsnark is installed, the tutorial model files will be present at `<path_to_xjsnark>/xjsnark/languages/xjsnark/sandbox/models/xjsnark/`. Now, replace the contents of that folder with the contents of `xjsnark_zkmb/` folder from this repository. Thus, the `<path_to_xjsnark>/xjsnark/languages/xjsnark/sandbox/models/xjsnark/` should now contain 11 .mps files. These can be viewed and read from MPS, which should automatically read the new files.

With an existing MPS installation: In the /models/xjsnark directory, copy all the ".mps" files into the sandbox/models/xjsnark directory of your MPS installation.

## Generating Circuits in MPS

In MPS, all modules by right-clicking on the module and clicking "Make <module>".   

When running a module, go to Run -> Edit Configurations and set the "working directory" to whichever file your test input files are in. All programs in this package that require a file to be read have a file name variable at the top to set.

Now, the generated .arith and .in files are generated in that directory. They can be run using libsnark (instructions below).

### Optimizer

To optimize the circuits, change the set `Config.multivariateExpressionMinimizer = true` in the main() file at the bottom of the program. The optimizer will use a lot more memory (we were able to run it on an EC2 instance with 32 GB RAM).

## Generating Circuits with Java

The circuits can be generated without using MPS and only using the source Java files (which are generated by xJsnark). This will the method to follow when using a remote server. 

Follow the instructions on "Generating circuits on a different platform" in the xJsnark repository to create the gen/ directory. The generated Java files to copy are the ones from the folder `sandbox/source\_gen/xjsnark`. Copy all folders from there into the gen/src/xjsnark/ folder and then run the java commands. We have already created a such a `gen/` directory using the current source files, so the above steps only need to be done when updating the code.

As written in the xJsnark repo's instructions, run `javac -d bin  -cp xjsnark_backend.jar $(find ./* | grep ".java$")` in `gen/` to compile the Java source files. The directory that the next command `java ...` is run becomes the working directory where the test files must be present. That is also where the .arith and .in files are will be generated.

There are three test files already present in the `\gen` directory: test.txt, test_doh.txt and test_wildcard.txt

To run the whole DNS experiment with the Shortcut channel opening, run the command `java -cp bin:xjsnark_backend.jar xjsnark.e2eDNS.DNS_Shortcut_dot` in `gen/`.

## Running jsnark on generated files

To generate the proof using the .arith and .in files, we use https://github.com/akosba/jsnark. We have downloaded the required files in the `jsnark/` directory. Follow the Prerequisites and "jsnark installation instructions" from the jsnark repository.

Once the .arith and .in files are generated (via MPS or Java), the libsnark command is as follows:  

In the gen/ directory, run `../jsnark/libsnark/build/libsnark/jsnark_interface/run_ppzksnark gg DNS_Shortcut_dot.arith DNS_Shortcut_dot_Sample_Run1_optimized.in`.

The general command is `<path to run_ppzksnark> gg <path to arith file> <path to in file>`.

The gg is for Groth16. Without it, the default is GGPR. 

## Generating TLS test files 

Currently, example test files "test.txt" and "test_doh.txt" and "test_wiildcard.txt" are provided. The first two are inputs for TLS 1.3 channel openings for DNS-over-TLS and DNS-over-HTTP, respectively. The test_wildcard.txt file contains a Merkle tree non-membership proof for a large blocklist of size 1 million for the queried URL "amazon.com".

### Generating more Test Cases

The `tls_testing/` directory contains our code to generate more test cases using our modified tlslite-ng (https://github.com/tlsfuzzer/tlslite-ng). The python file `generate_test.py ` creates more testing data. It starts a TLS session with Cloudflare or Google and outputs the input and witnesses required to open the TLS channel using the circuit. For example, run `python3 generate.py <query url>` to create testing data. The outputs of that file are explained in the comments at the code.

Generate DoH queries using `python3 generate.py <query url> -doh <GET/POST>`





