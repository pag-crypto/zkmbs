package xjsnark.channel_openings;

/*Generated by MPS */

import backend.structure.CircuitGenerator;
import backend.config.Config;
import backend.eval.SampleRun;
import java.io.BufferedReader;
import java.io.FileReader;
import java.math.BigInteger;
import backend.auxTypes.UnsignedInteger;
import util.Util;
import xjsnark.tls13_key_schedules.TLSKeySchedule;
import backend.eval.CircuitEvaluator;

public class ChannelShortcut extends CircuitGenerator {



  public static void main(String[] args) {
    Config.multivariateExpressionMinimization = true;
    Config.writeCircuits = true;
    Config.outputFilesPath = "./circuits";

    new ChannelShortcut();
  }

  public ChannelShortcut() {
    super("ChannelShortcut");
    __generateCircuit();
    this.__evaluateSampleRun(new SampleRun("Sample_Run1", true) {
      public void pre() {

        try {
          BufferedReader br = new BufferedReader(new FileReader(test_file_name));

          String psk_line = br.readLine();
          String sk_line = br.readLine();
          String Ax_line = br.readLine();
          String Ay_line = br.readLine();
          String Bx_line = br.readLine();
          String By_line = br.readLine();
          String HS_line = br.readLine();

          String H2_line = br.readLine();
          String H7_line = br.readLine();
          String H3_line = br.readLine();

          String SF_line = br.readLine();

          String pt2_line = br.readLine();
          String ct3_line = br.readLine();

          String dns_ct_line = br.readLine();

          String H_state_tr7_line = br.readLine();


          for (int i = 0; i < HS_line.length() / 2; i = i + 1) {
            HS[i].mapValue(new BigInteger(HS_line.substring(2 * i, 2 * i + 2), 16), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }

          for (int i = 0; i < H2_line.length() / 2; i = i + 1) {
            H2[i].mapValue(new BigInteger(H2_line.substring(2 * i, 2 * i + 2), 16), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }


          CH_SH_len.mapValue(BigInteger.valueOf(pt2_line.length() / 2), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());


          ServExt_len.mapValue(BigInteger.valueOf((ct3_line.length() / 2)), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());

          // Compute the tail 
          // This is used for efficient SHA computation 
          String ct3_tail_str = get_tail_minus_36(pt2_line + ct3_line);

          for (int i = 0; i < ct3_tail_str.length() / 2; i = i + 1) {
            ServExt_tail_ct[i].mapValue(new BigInteger(ct3_tail_str.substring(2 * i, 2 * i + 2), 16), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }

          ServExt_tail_len.mapValue(BigInteger.valueOf(ct3_tail_str.length() / 2), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());

          for (int i = ct3_tail_str.length() / 2; i < 128; i = i + 1) {
            ServExt_tail_ct[i].mapValue(new BigInteger("0"), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }

          // read the H_state 
          for (int i = 0; i < H_state_tr7_line.length() / 2; i = i + 1) {
            SHA_H_Checkpoint[i].mapValue(new BigInteger(H_state_tr7_line.substring(2 * i, 2 * i + 2), 16), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }

          for (int i = 0; i < dns_ct_line.length() / 2; i = i + 1) {
            appl_ct[i].mapValue(new BigInteger(dns_ct_line.substring(2 * i, 2 * i + 2), 16), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }
          for (int i = dns_ct_line.length() / 2; i < MAX_APPL_CT_LEN; i = i + 1) {
            appl_ct[i].mapValue(new BigInteger("0"), CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator());
          }


        } catch (Exception ex) {
          System.out.println("FILE NOT FIND OR LINE NOT READ");
        }


      }
      public void post() {
        System.out.println("Circuit Output: ");

        for (int j = 0; j < values.length; j++) {
          for (int i = 0; i < values[j].length; i++) {
            System.out.print(String.format("%1$02x", values[j][i].getValueFromEvaluator(CircuitGenerator.__getActiveCircuitGenerator().__getCircuitEvaluator())));
          }
          System.out.print("\n");
        }
      }

    });

  }



  public void __init() {
    test_file_name = "test.txt";
    HS = (UnsignedInteger[]) UnsignedInteger.createZeroArray(CircuitGenerator.__getActiveCircuitGenerator(), new int[]{32}, 8);
    SHA_H_Checkpoint = (UnsignedInteger[]) UnsignedInteger.createZeroArray(CircuitGenerator.__getActiveCircuitGenerator(), new int[]{32}, 8);
    H2 = (UnsignedInteger[]) UnsignedInteger.createZeroArray(CircuitGenerator.__getActiveCircuitGenerator(), new int[]{32}, 8);
    CH_SH_len = new UnsignedInteger(16, new BigInteger("0"));
    ServExt_len = new UnsignedInteger(16, new BigInteger("0"));
    ServExt_tail_ct = (UnsignedInteger[]) UnsignedInteger.createZeroArray(CircuitGenerator.__getActiveCircuitGenerator(), new int[]{128}, 8);
    ServExt_tail_len = new UnsignedInteger(8, new BigInteger("0"));
    appl_ct = (UnsignedInteger[]) UnsignedInteger.createZeroArray(CircuitGenerator.__getActiveCircuitGenerator(), new int[]{MAX_APPL_CT_LEN}, 8);
  }

  /*package*/ String test_file_name;
  public UnsignedInteger[] HS;
  public UnsignedInteger[] SHA_H_Checkpoint;
  public UnsignedInteger[] H2;
  public UnsignedInteger CH_SH_len;
  public UnsignedInteger ServExt_len;
  public UnsignedInteger[] ServExt_tail_ct;
  public UnsignedInteger ServExt_tail_len;
  public UnsignedInteger[] appl_ct;
  public UnsignedInteger[][] values;

  public static final int MAX_APPL_CT_LEN = 255;
  @Override
  public void __defineInputs() {
    super.__defineInputs();
    CH_SH_len = UnsignedInteger.createInput(this, 16);
    ServExt_len = UnsignedInteger.createInput(this, 16);
    ServExt_tail_len = UnsignedInteger.createInput(this, 8);



    H2 = (UnsignedInteger[]) UnsignedInteger.createInputArray(CircuitGenerator.__getActiveCircuitGenerator(), Util.getArrayDimensions(H2), 8);
    ServExt_tail_ct = (UnsignedInteger[]) UnsignedInteger.createInputArray(CircuitGenerator.__getActiveCircuitGenerator(), Util.getArrayDimensions(ServExt_tail_ct), 8);












  }
  @Override
  public void __defineOutputs() {
    super.__defineOutputs();









  }
  @Override
  public void __defineVerifiedWitnesses() {
    super.__defineVerifiedWitnesses();




    HS = (UnsignedInteger[]) UnsignedInteger.createVerifiedWitnessArray(CircuitGenerator.__getActiveCircuitGenerator(), Util.getArrayDimensions(HS), 8);
    SHA_H_Checkpoint = (UnsignedInteger[]) UnsignedInteger.createVerifiedWitnessArray(CircuitGenerator.__getActiveCircuitGenerator(), Util.getArrayDimensions(SHA_H_Checkpoint), 8);
    appl_ct = (UnsignedInteger[]) UnsignedInteger.createVerifiedWitnessArray(CircuitGenerator.__getActiveCircuitGenerator(), Util.getArrayDimensions(appl_ct), 8);















  }
  @Override
  public void __defineWitnesses() {
    super.__defineWitnesses();

















  }
  public void outsource() {

    UnsignedInteger[] SHA_H_Checkpoint_32 = xjsnark.util_and_sha.Util.convert_8_to_32(SHA_H_Checkpoint);

    values = TLSKeySchedule.get1RTT_HS_new(HS, H2, CH_SH_len.copy(16), ServExt_len.copy(16), ServExt_tail_ct, ServExt_tail_len.copy(8), SHA_H_Checkpoint_32, appl_ct);

  }
  public String get_tail_minus_36(String line) {

    String output = "";

    int len = (line.length() / 2);

    int num_whole_blocks = (len - 36) / 64;

    int tail_len = len - num_whole_blocks * 64;

    for (int i = 0; i < tail_len; i++) {
      int j = num_whole_blocks * 64 + i;
      output = output + line.substring(2 * j, 2 * j + 2);
    }

    return output;
  }

  public void __generateSampleInput(CircuitEvaluator evaluator) {
    __generateRandomInput(evaluator);
  }

}
